/**
  * Convert P10le (16 bit for 10 bit) to PP01 (packed 10 bit, 10 bit for 10 bit)
  *
  */

#include <stdint.h>
#include <stddef.h>
#include <x86intrin.h>

#include "pack.h"

typedef struct
{
    unsigned width;
    unsigned height;
    unsigned dst_stride_size;
    unsigned src_stride_size;
    unsigned stride_alignment_bytes;
    const uint8_t *psrc;
    size_t length;
    uint8_t *pdst;
    uint8_t *dst_planes[3]; // [Y][U][V] Planes
    uint8_t *src_planes[3]; // [Y][U][V] Planes
} FCOPYMODULE_ARG_BASE_T;


/**
  *         LSB                                 MSB
  *  pix0   00  01  02  03  04  05  06  07   08  09
  *         <----------data[0]----------->  <data[1]>
  *
  *  pix0: [00...07] = y[0], [08, 09] = y[1] & 0x03;
  *
  *
  *  pix1   10  11  12  13  14  15   16  17  18  19
  *         <-------data[1]------>   <---data[2]--->
  *
  *  pix1: [10...17] = y[2], [18, 19] = y[3] & 0x03;
  *
  *
  *  pix2   20  21  22  23   24  25  26  27  28  29
  *         <---data[2]--->  <------data[3]------->
  *
  *  pix2: [20...27] = y[4], [28, 29] = y[5] & 0x03;
  *
  *
  *  pix3   30  31   32  33  34  35  36  37  38  39
  *        <data[3]> <----------data[4]------------>
  *
  *  pix3: [30...37] = y[6], [38, 39] = y[7] & 0x03;
  *
  *
  */
void pack_y(QUATRE_PIX_T *q_pix, uint8_t *y)
{    
    //
    // y[0] has 8 valid bits
    // so data[0] = y[0]
    //
    q_pix->data[0] = y[0];
    
    //
    // y[1] has 2 valid bits
    // data[1] filled with y[1], and it(data[1]) has 6 bits space left
    //
    // y[2] has 8 valid bits
    // Let 6 out of them goes into data[1]:
    //
    // 07 06 05 04 03 02   01  00
    // < y[2] & 3f << 2>   <y[1]>
    //
    q_pix->data[1] = (y[1]) |       // y[1] valid 2 bit
                     ((y[2] & 0x3F) << 2); // 6 bit

    //
    // Now y[2] has 2 bits left,
    // y[3] has 2 valids bits,
    // y[4] has 8 valid bits, fit 4 bits in data[2]
    // 
    // 07   06   05   04   03  02   01  00
    // <y[4] & 0xf << 4>   <y[3]>   <y[2]>
    //    
    q_pix->data[2] = (y[2] >> 6) |  // 2 bit
                     (y[3] << 2) |  // 2 bit
                     (y[4] << 4);   // 4 bit

    //
    // Now y[4] has 4 valid bit left fit 4 bits in data[3]
    // y[5] has 2 valid bits
    // data[3] has 2 more space left, fit 2 bits from y[6]
    //
    // 07  06   05  04   03  02 01  00
    // <y[6]>   <y[5]>   <y[4] & 0xf0>
    //
    q_pix->data[3] = (y[4] >> 4) |  // 4 bit
                     (y[5] << 4) |  // 2 bit
                     (y[6] << 6);   // 2 bit
                    
    //
    // Now y[6] has 6 valid bits left, fit in data[4]
    // y[7] has 2 valid bits.
    //
    // 07  06   05  04 03 02 01 00
    // <y[7]>   <y[6] & 0xfc >> 2>
    //
    q_pix->data[4] = (y[6] >> 2) |
                     (y[7] << 6);
}


/**
  *           LSB                                 MSB
  *  pix u0   00  01  02  03  04  05  06  07   08  09
  *           <----------data[0]----------->  <data[1]>
  *
  *  pix u0: [00...07] = u[0], [08, 09] = u[1] & 0x03;
  *
  *
  *  pix v0   10  11  12  13  14  15   16  17  18  19
  *           <-------data[1]------>   <---data[2]--->
  *
  *  pix v0: [10...17] = v[0], [18, 19] = v[0] & 0x03;
  *
  *
  *  pix u1   20  21  22  23   24  25  26  27  28  29
  *           <---data[2]--->  <------data[3]------->
  *
  *  pix u1: [20...27] = u[2], [28, 29] = u[3] & 0x03;
  *
  *
  *  pix v1   30  31   32  33  34  35  36  37  38  39
  *           <data[3]> <----------data[4]---------->
  *
  *  pix v1: [30...37] = v[2], [38, 39] = v[3] & 0x03;
  *
  *
  */
void pack_uv(QUATRE_PIX_T *q_pix, uint8_t *u, uint8_t *v)
{    
    // data[0]
    q_pix->data[0] = u[0];
    
    // data[1]
    q_pix->data[1] = (u[1]) |
                     (v[0] << 2);

    // data[2]
    q_pix->data[2] = (v[0] >> 6) |  // 2 bit
                     (v[1] << 2) |  // 2 bit
                     (u[2] << 4); // 4 bit

    // data[3]
    q_pix->data[3] = (u[2] >> 4) |  // 4 bit
                     (u[3] << 4) |  // 2 bit
                     (v[2] << 6);   // 2 bit
                    
    // data[4]
    q_pix->data[4] = (v[2] >> 2) |
                     (v[3] << 6);
}

static void framecopy_I0AL_Y_to_PP01_SSE2Sub(FCOPYMODULE_ARG_BASE_T *arg)
{
    const uint8_t *srcptr;
    uint8_t *dstptr;
    const uint8_t *line_src;
    uint8_t *line_dst;

    dstptr = arg->pdst;
    srcptr = arg->psrc;

    __m128i scalar0 = _mm_set_epi16(1, 64, 1, 64, 1, 64, 1, 64);
    __m128i mask0 = _mm_set1_epi64x(0x000FFFFF00000000ULL);

    for (uint32_t r = 0; r < arg->height; r++)
    {
        line_src = srcptr;
        line_dst = dstptr;

        for (uint32_t c = arg->src_stride_size; c >= (128 / 8); c -= (128 / 8))
        {
            __m128i w;
            __m128i a;

            // W:=8 pixels/128 bits
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // Y7-------L000000Y6-------L000000Y5-------L000000Y4-------L000000Y3-------L000000Y2-------L000000Y1-------L000000Y0-------L000000
            w = _mm_loadu_si128((__m128i const *)line_src);

            // W:=W (*16) below
            // mm_mullo_epi16
            // *1              *64             *1              *64             *1              *64             *1 *64
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000Y7-------LY6-------L000000000000Y5-------LY4-------L000000000000Y3-------LY2-------L000000000000Y1-------LY0-------L000000
            w = _mm_mullo_epi16(w, scalar0);

            // W:=W>>6
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000Y7-------LY6-------L000000000000Y5-------LY4-------L000000000000Y3-------LY2-------L000000000000Y1-------LY0-------L
            w = _mm_srli_epi64(w, 6);

            // A:=W (&) below
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 00000000000011111111111111111111000000000000000000000000000000000000000000001111111111111111111100000000000000000000000000000000
            // A:=
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000Y7-------LY6-------L00000000000000000000000000000000000000000000Y3-------LY2-------L00000000000000000000000000000000
            a = _mm_and_si128(w, mask0);

            // W:=W xor A
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 00000000000000000000000000000000000000000000Y5-------LY4-------L00000000000000000000000000000000000000000000Y1-------LY0-------L
            //          w = _mm_xor_si128(w, a);
            w = _mm_andnot_si128(mask0, w);

            // A:=A>>12
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000Y7-------LY6-------L00000000000000000000000000000000000000000000Y3-------LY2-------L00000000000000000000
            a = _mm_srli_epi64(a, 12);

            // W:=A|W
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000Y7-------LY6-------LY5-------LY4-------L000000000000000000000000Y3-------LY2-------LY1-------LY0-------L
            w = _mm_or_si128(a, w);

            // A:=W low 64
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000Y3-------LY2-------LY1-------LY0-------L
            a = _mm_move_epi64(w);

            // B:=W xor A
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000Y7-------LY6-------LY5-------LY4-------L0000000000000000000000000000000000000000000000000000000000000000
            w = _mm_xor_si128(w, a);

            // B:=B>>24:=B>>(3*8) _mm_bsrli_si128
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000000000000000000000000000Y7-------LY6-------LY5-------LY4-------L0000000000000000000000000000000000000000
            w = _mm_srli_si128(w, 3);

            // W:=A|B #QED
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000000000000000000000000000Y7-------LY6-------LY5-------LY4-------LY3-------LY2-------LY1-------LY0-------L
            w = _mm_or_si128(w, a);
            _mm_storel_epi64((__m128i *)line_dst, w);
            line_dst += 8;
            *(uint16_t *)line_dst = (uint16_t)_mm_extract_epi16(w, 4);
            line_dst += 2;
            line_src += 16;
        }
        dstptr += (intptr_t)arg->dst_stride_size;
        srcptr += (intptr_t)arg->src_stride_size;
    }
}


static void framecopy_I0AL_UV_to_PP01_SSE2Sub(FCOPYMODULE_ARG_BASE_T *arg)
{
    const uint8_t *srcptr;
    uint8_t *dstptr;
    const uint8_t *u_ptr;
    const uint8_t *v_ptr;
    uint8_t *line_dst;

    dstptr = arg->pdst;
    srcptr = arg->psrc;

    __m128i scalar0 = _mm_set_epi16(1, 64, 1, 64, 1, 64, 1, 64);
    __m128i mask0 = _mm_set1_epi64x(0x000FFFFF00000000ULL);

    //printf("width=%d height=%d src_stride_size=%d dst_stride_size=%d\n", arg->width, arg->height, arg->src_stride_size, arg->dst_stride_size);

    for (uint32_t r = 0; r < arg->height; r++)
    {
        u_ptr = srcptr;
        v_ptr = srcptr + arg->width * arg->height * 2;
        line_dst = dstptr;

        for (uint32_t c = 0; c < arg->width; c += 8)
        {
            //printf("r=%d c=%d\n", r, c);
            __m128i w;
            __m128i a;

            // W:=8 pixels/128 bits
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000V3-------L000000U3-------L000000V2-------L000000U2-------L000000V1-------L000000U1-------L000000V0-------L000000U0-------L
            // lower part
            w = _mm_unpacklo_epi16(*(__m128i const *) u_ptr, *(__m128i const *) v_ptr);

            // W:=W (*16) below
            // mm_mullo_epi16
            // *1              *64             *1              *64             *1              *64             *1 *64
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000Y7-------LY6-------L000000000000Y5-------LY4-------L000000000000Y3-------LY2-------L000000000000Y1-------LY0-------L000000
            w = _mm_mullo_epi16(w, scalar0);

            // W:=W>>6
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000Y7-------LY6-------L000000000000Y5-------LY4-------L000000000000Y3-------LY2-------L000000000000Y1-------LY0-------L
            w = _mm_srli_epi64(w, 6);

            // A:=W (&) below
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 00000000000011111111111111111111000000000000000000000000000000000000000000001111111111111111111100000000000000000000000000000000
            // A:=
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000Y7-------LY6-------L00000000000000000000000000000000000000000000Y3-------LY2-------L00000000000000000000000000000000
            a = _mm_and_si128(w, mask0);

            // W:=W xor A
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 00000000000000000000000000000000000000000000Y5-------LY4-------L00000000000000000000000000000000000000000000Y1-------LY0-------L
            //          w = _mm_xor_si128(w, a);
            w = _mm_andnot_si128(mask0, w);

            // A:=A>>12
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000Y7-------LY6-------L00000000000000000000000000000000000000000000Y3-------LY2-------L00000000000000000000
            a = _mm_srli_epi64(a, 12);

            // W:=A|W
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000Y7-------LY6-------LY5-------LY4-------L000000000000000000000000Y3-------LY2-------LY1-------LY0-------L
            w = _mm_or_si128(a, w);

            // A:=W low 64
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000Y3-------LY2-------LY1-------LY0-------L
            a = _mm_move_epi64(w);

            // B:=W xor A
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000Y7-------LY6-------LY5-------LY4-------L0000000000000000000000000000000000000000000000000000000000000000
            w = _mm_xor_si128(w, a);

            // B:=B>>24:=B>>(3*8) _mm_bsrli_si128
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000000000000000000000000000Y7-------LY6-------LY5-------LY4-------L0000000000000000000000000000000000000000
            w = _mm_srli_si128(w, 3);

            // W:=A|B #QED
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000000000000000000000000000Y7-------LY6-------LY5-------LY4-------LY3-------LY2-------LY1-------LY0-------L
            w = _mm_or_si128(w, a);

            _mm_storel_epi64((__m128i *)line_dst, w);

            line_dst += 8;
            *(uint16_t *) line_dst = (uint16_t) _mm_extract_epi16(w, 4);
            line_dst += 2;

            // W:=8 pixels/128 bits
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000V7-------L000000U7-------L000000V6-------L000000U6-------L000000V5-------L000000U5-------L000000V4-------L000000U4-------L
            // higher part
            w = _mm_unpackhi_epi16(*(__m128i const *) u_ptr, *(__m128i const *) v_ptr);

            // W:=W (*16) below
            // mm_mullo_epi16
            // *1              *64             *1              *64             *1              *64             *1 *64
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000Y7-------LY6-------L000000000000Y5-------LY4-------L000000000000Y3-------LY2-------L000000000000Y1-------LY0-------L000000
            w = _mm_mullo_epi16(w, scalar0);

            // W:=W>>6
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000Y7-------LY6-------L000000000000Y5-------LY4-------L000000000000Y3-------LY2-------L000000000000Y1-------LY0-------L
            w = _mm_srli_epi64(w, 6);

            // A:=W (&) below
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 00000000000011111111111111111111000000000000000000000000000000000000000000001111111111111111111100000000000000000000000000000000
            // A:=
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000Y7-------LY6-------L00000000000000000000000000000000000000000000Y3-------LY2-------L00000000000000000000000000000000
            a = _mm_and_si128(w, mask0);

            // W:=W xor A
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 00000000000000000000000000000000000000000000Y5-------LY4-------L00000000000000000000000000000000000000000000Y1-------LY0-------L
            //          w = _mm_xor_si128(w, a);
            w = _mm_andnot_si128(mask0, w);

            // A:=A>>12
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000Y7-------LY6-------L00000000000000000000000000000000000000000000Y3-------LY2-------L00000000000000000000
            a = _mm_srli_epi64(a, 12);

            // W:=A|W
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000Y7-------LY6-------LY5-------LY4-------L000000000000000000000000Y3-------LY2-------LY1-------LY0-------L
            w = _mm_or_si128(a, w);

            // A:=W low 64
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000Y3-------LY2-------LY1-------LY0-------L
            a = _mm_move_epi64(w);

            // B:=W xor A
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000Y7-------LY6-------LY5-------LY4-------L0000000000000000000000000000000000000000000000000000000000000000
            w = _mm_xor_si128(w, a);

            // B:=B>>24:=B>>(3*8) _mm_bsrli_si128
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000000000000000000000000000Y7-------LY6-------LY5-------LY4-------L0000000000000000000000000000000000000000
            w = _mm_srli_si128(w, 3);

            // W:=A|B #QED
            // 77777777777777776666666666666666555555555555555544444444444444443333333333333333222222222222222211111111111111110000000000000000
            // FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210FEDCBA9876543210
            // ===============#===============#===============#===============#===============#===============#===============#===============#
            // 000000000000000000000000000000000000000000000000Y7-------LY6-------LY5-------LY4-------LY3-------LY2-------LY1-------LY0-------L
            w = _mm_or_si128(w, a);

            _mm_storel_epi64((__m128i *)line_dst, w);

            line_dst += 8;
            *(uint16_t *) line_dst = (uint16_t) _mm_extract_epi16(w, 4);
            line_dst += 2;

            u_ptr += 16;
            v_ptr += 16;
        }
        dstptr += arg->dst_stride_size;
        srcptr += arg->src_stride_size;
    }
}


void framecopy_I0AL_to_PP01(uint32_t width, uint32_t height, uint8_t *srcmem[], uint8_t *dstmem)
{
    FCOPYMODULE_ARG_BASE_T arg;
    div_t divret;

    divret = div((int)(width * 10 + 15), (int)16);
    arg.dst_stride_size = (unsigned) divret.quot * 2;
    arg.src_stride_size = (intptr_t) width * 2;
    arg.width = width;
    arg.height = height;
    arg.psrc = srcmem[0];
    arg.pdst = dstmem;

    framecopy_I0AL_Y_to_PP01_SSE2Sub(&arg);

    arg.psrc = srcmem[1];
    arg.pdst = dstmem + arg.dst_stride_size * height;
    arg.height = (height + 1) / 2;
    arg.width /= 2;
    arg.src_stride_size /= 2;

    framecopy_I0AL_UV_to_PP01_SSE2Sub(&arg);
}

size_t framesize_PP01(uint32_t width, uint32_t height)
{
    size_t line;
    line = (width * 10 + 31) / 32;
    line = line * 4;
    line = line * ((size_t)height + ((height + 1) / 2));
    return line;
}

